
#include "alignment_parameters.h"

int set_subm_gaps(struct parameters* param, struct aln_param* ap);

struct aln_param* init_ap(struct parameters* param,int numseq)
{
        struct aln_param* ap = NULL;
        int i,j;


        MMALLOC(ap, sizeof(struct aln_param));

        ap->tree = NULL;
        MMALLOC(ap->tree, sizeof(int) * (numseq*3+1));

        ap->subm = NULL;
        MMALLOC(ap->subm,sizeof (float*) * 32);
        for (i = 32;i--;){
                ap->subm[i] = NULL;
                MMALLOC(ap->subm[i],sizeof(float) * 32);
                for (j = 32;j--;){
                        ap->subm[i][j] = 0.0f;
                }
        }
        RUN(set_subm_gaps(param, ap));

        return ap;
ERROR:
        free_ap(ap);
        return NULL;
}

void free_ap(struct aln_param* ap)
{
        int i;
        if(ap){
                if(ap->subm){
                        for (i = 32;i--;){
                                MFREE(ap->subm[i]);
                        }
                        MFREE(ap->subm);
                }
                if(ap->tree){
                        MFREE(ap->tree);
                }
                MFREE(ap);
        }
}


int set_subm_gaps(struct parameters* param, struct aln_param* ap)
{
        int i,j;
        int m_pos = 0;
        short *matrix_pointer = 0;
        short blosum50mt[]={
                5,
                -2,  5,
                -1, -3, 13,
                -2,  5, -4,  8,
                -1,  1, -3,  2,  6,
                -3, -4, -2, -5, -3,  8,
                0, -1, -3, -1, -3, -4,  8,
                -2,  0, -3, -1,  0, -1, -2, 10,
                -1, -4, -2, -4, -4,  0, -4, -4,  5,
                -1,  0, -3, -1,  1, -4, -2,  0, -3,  6,
                -2, -4, -2, -4, -3,  1, -4, -3,  2, -3,  5,
                -1, -3, -2, -4, -2,  0, -3, -1,  2, -2,  3,  7,
                -1,  4, -2,  2,  0, -4,  0,  1, -3,  0, -4, -2,  7,
                -1, -2, -4, -1, -1, -4, -2, -2, -3, -1, -4, -3, -2, 10,
                -1,  0, -3,  0,  2, -4, -2,  1, -3,  2, -2,  0,  0, -1,  7,
                -2, -1, -4, -2,  0, -3, -3,  0, -4,  3, -3, -2, -1, -3,  1,  7,
                1,  0, -1,  0, -1, -3,  0, -1, -3,  0, -3, -2,  1, -1,  0, -1,  5,
                0,  0, -1, -1, -1, -2, -2, -2, -1, -1, -1, -1,  0, -1, -1, -1,  2,  5,
                0, -4, -1, -4, -3, -1, -4, -4,  4, -3,  1,  1, -3, -3, -3, -3, -2,  0,  5,
                -3, -5, -5, -5, -3,  1, -3, -3, -3, -3, -2, -1, -4, -4, -1, -3, -4, -3, -3, 15,
                -1, -1, -2, -1, -1, -2, -2, -1, -1, -1, -1, -1, -1, -2, -1, -1, -1,  0, -1, -3, -1,
                -2, -3, -3, -3, -2,  4, -3,  2, -1, -2, -1,  0, -2, -3, -1, -1, -2, -2, -1,  2, -1,  8,
                -1,  2, -3,  1,  5, -4, -2,  0, -3,  1, -3, -1,  0, -1,  4,  0,  0, -1, -3, -2, -1, -2,  5};

        short blosum62mt[]={
                40,
                -20,  40,
                0, -30,  90,
                -20,  40, -30,  60,
                -10,  10, -40,  20,  50,
                -20, -30, -20, -30, -30,  60,
                0, -10, -30, -10, -20, -30,  60,
                -20,  0, -30, -10,  0, -10, -20,  80,
                -10, -30, -10, -30, -30,  0, -40, -30,  40,
                -10,  0, -30, -10,  10, -30, -20, -10, -30,  50,
                -10, -40, -10, -40, -30,  0, -40, -30,  20, -20,  40,
                -10, -30, -10, -30, -20,  0, -30, -20,  10, -10,  20,  50,
                -20,  30, -30,  10,  0, -30,  0,  10, -30,  0, -30, -20,  60,
                -10, -20, -30, -10, -10, -40, -20, -20, -30, -10, -30, -20, -20,  70,
                -10,  0, -30,  0,  20, -30, -20,  0, -30,  10, -20,  0,  0, -10,  50,
                -10, -10, -30, -20,  0, -30, -20,  0, -30,  20, -20, -10,  0, -20,  10,  50,
                10,  0, -10,  0,  0, -20,  0, -10, -20,  0, -20, -10,  10, -10,  0, -10,  40,
                0, -10, -10, -10, -10, -20, -20, -20, -10, -10, -10, -10,  0, -10, -10, -10,  10,  50,
                0, -30, -10, -30, -20, -10, -30, -30,  30, -20,  10,  10, -30, -20, -20, -30, -20,  0,  40,
                -30, -40, -20, -40, -30,  10, -20, -20, -30, -30, -20, -10, -40, -40, -20, -30, -30, -20, -30, 110,
                0, -10, -20, -10, -10, -10, -10, -10, -10, -10, -10, -10, -10, -20, -10, -10,  0,  0, -10, -20, -10,
                -20, -30, -20, -30, -20,  30, -30,  20, -10, -20, -10, -10, -20, -30, -10, -20, -20, -20, -10,  20, -10,  70,
                -10,  10, -30,  10,  40, -30, -20,  0, -30,  10, -30, -10,  0, -10,  30,  0,  0, -10, -20, -30, -10, -20,  40};

        short gon250mt[]={
                24,
                0,   0,
                5,   0, 115,
                -3,   0, -32,  47,
                0,   0, -30,  27,  36,
                -23,   0,  -8, -45, -39,  70,
                5,   0, -20,   1,  -8, -52,  66,
                -8,   0, -13,   4,   4,  -1, -14,  60,
                -8,   0, -11, -38, -27,  10, -45, -22,  40,
                -4,   0, -28,   5,  12, -33, -11,   6, -21,  32,
                -12,   0, -15, -40, -28,  20, -44, -19,  28, -21,  40,
                -7,   0,  -9, -30, -20,  16, -35, -13,  25, -14,  28,  43,
                -3,   0, -18,  22,   9, -31,   4,  12, -28,   8, -30, -22,  38,
                3,   0, -31,  -7,  -5, -38, -16, -11, -26,  -6, -23, -24,  -9,  76,
                -2,   0, -24,   9,  17, -26, -10,  12, -19,  15, -16, -10,   7,  -2,  27,
                -6,   0, -22,  -3,   4, -32, -10,   6, -24,  27, -22, -17,   3,  -9,  15,  47,
                11,   0,   1,   5,   2, -28,   4,  -2, -18,   1, -21, -14,   9,   4,   2,  -2,  22,
                6,   0,  -5,   0,  -1, -22, -11,  -3,  -6,   1, -13,  -6,   5,   1,   0,  -2,  15,  25,
                1,   0,   0, -29, -19,   1, -33, -20,  31, -17,  18,  16, -22, -18, -15, -20, -10,   0,  34,
                -36,   0, -10, -52, -43,  36, -40,  -8, -18, -35,  -7, -10, -36, -50, -27, -16, -33, -35, -26, 142,
                0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
                -22,   0,  -5, -28, -27,  51, -40,  22,  -7, -21,   0,  -2, -14, -31, -17, -18, -19, -19, -11,  41,   0,  78,
                0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0};


        if(param->sub_matrix){
                if(byg_start(param->sub_matrix,"blosum62BLOSUM62") != -1){
                        matrix_pointer = blosum62mt;
                        //m_pos = 0;
                        //for (i = 0;i < 23;i++){
                        //	for (j = 0;j <= i;j++){
                        //		matrix_pointer[m_pos] = matrix_pointer[m_pos] * 10;
                        //		m_pos++;
                        //	}
                        //}
                        ap->gpo = 55;
                        ap->gpe = 8;
                        ap->tgpe = 1;
                }
                if(byg_start(param->sub_matrix,"blosum50BLOSUM50") != -1){
                        matrix_pointer = blosum50mt;
                        m_pos = 0;
                        for (i = 0;i < 23;i++){
                                for (j = 0;j <= i;j++){
                                        matrix_pointer[m_pos] = matrix_pointer[m_pos] * 10;
                                        m_pos++;
                                }
                        }
                        ap->gpo = 55;
                        ap->gpe = 8;
                        ap->tgpe = 1;
                }
                //vogt....

        }else{
                //LOG_MSG("DNA>>>>> %d", param->dna);
                if(!param->dna){
                        // gpo:5.494941        gpe:0.852492        tgpe:0.442410       bonus: 3.408872     z-cutoff: 58.823309 -> 0.829257 accuracy on bb3
                        ap->gpo = 54.94941;
                        ap->gpe = 8.52492;
                        ap->tgpe = 4.42410;

                        //gpo = 54;
                        //gpe = 8;
                        //tgpe = 4;
                        //-gpo 10.9898        -gpe 0.852492      -tgpe  0.442410    -bonus    0.2   -zcutoff     58.823309
                        //	param->secret = 0.2;
                        matrix_pointer = gon250mt;
                }else{
                        //gpo = 400;
                        //	gpe =  30;
                        //tgpe = 30;

                        //param->gpo = 43.4;
                        //param->gpe = 3.94;
                        //param->tgpe = 29.26;

                        //gpo = 43.4 *5;
                        ap->gpo = 217;
                        ap->gpe = 39.4;
                        ap->tgpe =  292.6;
                        //param->secret = 28.3;
                        param->zlevel = 61.08;
                        param->internal_gap_weight = 49.14;

                }
        }
        if(param->gpo!= -1){
                //param->gpo *= 5;
                ap->gpo = param->gpo;
        }
        if(param->gpe != -1){
                //param->gpe *= 10;
                ap->gpe = param->gpe;
        }
        if(param->tgpe != -1){
                //param->tgpe *= 10;
                ap->tgpe = param->tgpe;
        }

//	if(param->secret != -1){
//		//param->secret *= 10;
//	}else{
        if(param->secret == -1){
                if(!param->dna){
                        param->secret = 0.2;
                }else{
                        param->secret = 283.0;
                }
        }


        //fprintf(stderr,"%d	%d	%d	%d\n",gpo,gpe,tgpe,	 (int)param->secret);

        for (i = 32;i--;){

                for (j = 32;j--;){
                        ap->subm[i][j] = param->secret;//0;//gpe << 1;//-5;// better on Balibase
                }
        }
        if(param->dna){
                /*subm[0][0] += 10;
                  subm[0][1] += 6;
                  subm[1][0] += 6;
                  subm[1][1] += 10;
                  subm[2][2] += 10;
                  subm[2][3] += 6;
                  subm[3][2] += 6;
                  subm[3][3] += 10;*/
//		     A    C    G    T    .    N
//	A   91 -114  -31 -123    0  -43
                ap->subm[0][0] += 91;
                ap->subm[0][1] += -114;
                ap->subm[0][2] += -31;
                ap->subm[0][3] += -123;

//	C -114  100 -125  -31    0  -43
                ap->subm[1][0] += -114;
                ap->subm[1][1] += 100;
                ap->subm[1][2] += -125;
                ap->subm[1][3] += -31;

//	G  -31 -125  100 -114    0  -43
                ap->subm[2][0] += -31;
                ap->subm[2][1] += -125;
                ap->subm[2][2] += 100;
                ap->subm[2][3] += -114;

//	T -123  -31 -114   91    0  -43
                ap->subm[3][0] += -123;
                ap->subm[3][1] += -31;
                ap->subm[3][2] += -114;
                ap->subm[3][3] += 91;

//	.    0    0    0    0    0    0
//	N  -43  -43  -43  -43    0  -43


                /*for (i = 0; i < 4;i++){
                  for (j = 0;j < 4;j++){
                  if(i == j){
                  subm[i][j] += 1;
                  }else{
                  subm[i][j] -= 3;
                  }
                  }
                  }*/

        }else{

                m_pos = 0;
                for (i = 0;i < 23;i++){
                        for (j = 0;j <= i;j++){
                                if (i == j){
                                        //	subm[i][j] += blosum62mt[m_pos]*10;
                                        ap->subm[i][j] += matrix_pointer[m_pos];
                                }else{
                                        //	subm[i][j] += blosum62mt[m_pos]*10;
                                        //	subm[j][i] += blosum62mt[m_pos]*10;
                                        ap->subm[i][j] += matrix_pointer[m_pos];
                                        ap->subm[j][i] += matrix_pointer[m_pos];
                                }
                                m_pos++;
                        }
                }
                /*for (i = 0; i < 23;i++){
                  for (j = 0; j < 23;j++){
                  fprintf(stderr,"%d ",subm[i][j]);
                  }
                  fprintf(stderr,"\n");
                  }
                  fprintf(stderr,"\n");*/
        }

float balimt[]={
 1.849052,
 0.372544, 8.809702,
 1.211249, -3.277959, 4.634354,
 0.140570, 3.018300, -0.622507, 2.555185,
 0.558028, 1.579274, -0.712552, 1.572029, 2.120800,
 -0.068843, -1.650869, 0.431215, -0.782673, -0.662694, 2.936084,
 0.620470, 0.046190, -0.247785, 0.199658, -0.113629, -0.765865, 2.654120,
 0.093480, -0.424811, -0.036674, 0.567051, 0.536195, 0.618376, -0.229641, 3.598301,
 0.265935, -1.758840, 0.581371, -1.052908, -0.647097, 0.985359, -1.189289, -0.389245, 2.206425,
 0.589351, 1.299587, -0.607510, 0.704479, 1.259131, -0.600944, 0.075190, 0.684481, -0.426389, 2.087642,
 0.216197, -2.320578, 0.480847, -0.841887, -0.473886, 1.433806, -1.044037, 0.023722, 1.761782, -0.175197, 1.951661,
 0.470002, -0.441471, 0.854404, -0.581883, -0.104354, 1.337805, -0.649284, 0.176266, 1.382144, 0.176465, 1.914259, 3.115168,
 0.302650, 2.697917, 0.100485, 1.453161, 0.749003, -0.320885, 0.697032, 1.202547, -0.667964, 0.868777, -0.308525, 0.005366, 2.619825,
 0.376142, -0.807794, -0.068146, 0.273017, 0.417442, -0.181780, -0.031290, 0.024348, -0.354944, 0.320431, -0.288023, -0.274413, 0.230434, 3.210582,
 0.566216, 0.825898, -0.236997, 0.859656, 1.483817, -0.174535, -0.076775, 1.083930, -0.254372, 1.443437, 0.153290, 0.645358, 0.904805, 0.238190, 2.502263,
 0.224581, -0.943270, -0.168192, 0.160296, 0.664461, -0.457550, -0.352597, 0.921326, -0.344874, 1.727843, -0.107636, 0.142726, 0.606381, 0.009136, 1.237170, 2.724726,
 1.234534, 1.478581, 0.745337, 0.726211, 0.624246, -0.231044, 0.605146, 0.403261, -0.413101, 0.614009, -0.352169, 0.154176, 1.076901, 0.550163, 0.679864, 0.374362, 2.082990,
 0.725392, 0.854530, 0.882818, 0.320171, 0.432740, 0.015641, -0.069920, 0.341097, 0.349131, 0.561450, 0.152083, 0.524339, 0.708739, 0.197835, 0.593198, 0.357972, 1.583503, 2.342092,
 0.773366, -2.147500, 1.171485, -0.864906, -0.409620, 0.694415, -0.997801, -0.157011, 2.204490, -0.148733, 1.264725, 1.035945, -0.434917, -0.060552, -0.061817, -0.223705, -0.068628, 0.863866, 2.046256,
 -0.218657, -1.534724, -0.154327, -0.475857, -0.456871, 1.859663, -0.692018, 0.929678, 0.176956, -0.413620, 0.499663, 0.740935, -0.193446, -0.494466, -0.025010, -0.110807, -0.052408, -0.111690, 0.067173, 4.910911,
 0.912212, 1.371767, 1.528053, 0.147719, 0.450553, 1.509597, -0.153982, -0.425382, 1.961429, 0.700764, 1.695595, 2.281540, 0.191541, -1.608048, 0.607427, 0.071719, 0.960991, 0.607247, 1.549990, -0.242614, 2.237613,
 -0.008458, 0.135721, 0.154876, -0.415666, -0.371196, 2.352677, -0.677789, 1.446779, 0.245467, -0.151958, 0.639010, 0.687954, -0.068308, -0.350080, 0.194190, 0.181753, -0.044675, 0.013198, 0.203707, 2.082309, 0.450730, 3.278049,
 0.923956, 8.476709, -0.580191, 1.503516, 2.560432, -2.248556, -0.127271, -0.304845, -2.251755, 1.511696, -1.564465, -1.037010, 0.363655, -0.019423, 3.827421, -0.913766, 0.792201, 0.578038, -0.637505, -5.006881, 0.899611, -2.154059, 9.085171,
};
        ap->gpo = 7.214270/2.0;
ap->gpe =  0.361495;
ap->tgpe =  0.000000;

        m_pos = 0;
        for (i = 0;i < 23;i++){
                for (j = 0;j <= i;j++){
                        if (i == j){
                                //	subm[i][j] += blosum62mt[m_pos]*10;
                                ap->subm[i][j] = balimt[m_pos]*2;
                        }else{
                                //	subm[i][j] += blosum62mt[m_pos]*10;
                                //	subm[j][i] += blosum62mt[m_pos]*10;
                                ap->subm[i][j] = balimt[m_pos]*2;
                                ap->subm[j][i] = balimt[m_pos]*2;
                        }
                        m_pos++;
                }
        }


        return OK;
}
