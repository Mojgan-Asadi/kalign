#+TITLE:  Test kalign on BAliBASE 
#+AUTHOR: Timo Lassmann
#+EMAIL:  timo.lassmann@telethonkids.org.au
#+DATE:   2019-04-23
#+LATEX_CLASS: report
#+OPTIONS:  toc:nil
#+OPTIONS: H:4
#+LATEX_CMD: pdflatex
* Introduction 
  Let's run kalign on the core BAliBASE test alignments. 
  
* Method 

** Step 1: install balibase 

   #+BEGIN_SRC sh
     cd 
     mkdir -p data
     cd data
     if [ ! -f BAliBASE_R1-5.tar.gz ]; then
         wget https://www.lbgi.fr/balibase/BalibaseDownload/BAliBASE_R1-5.tar.gz

     fi
     tar -zxvf  BAliBASE_R1-5.tar.gz
   #+END_SRC

   #+RESULTS:

   BAliBASE comes with a C program to score alignments. Unfortunately, something is wrong with the bundled expat library. To fix this install expat system and remove the links to the bundled library by editing the makefile: 

   #+BEGIN_EXAMPLE makefile 
   CC	= cc
   CFLAGS  = -c -O #-I$(EXPAT_INC)
   LFLAGS	= -O -lm -lexpat #-L$(EXPAT_LIB) -lexpat
   EXPAT_LIB	= expat-1.95.2/lib
   EXPAT_INC	= expat-1.95.2/include
   #+END_EXAMPLE

   Also, by default bali_score will use all columns for the TC score. In the original clustal omega paper only core blocks are used to calculate the TC scores supercite:sievers-2014-fast-scalab. To change this modify =bali_score.c= line 104 from: 

   #+BEGIN_EXAMPLE C 
   method='C' 
   #+END_EXAMPLE

   to: 

   #+BEGIN_EXAMPLE C 
   method='B' 
   #+END_EXAMPLE

   Then compile:

   #+BEGIN_SRC sh 
     cd ~/data/bb3_release/bali_score_src
     make 
   #+END_SRC

   #+RESULTS:
   | cc | -c | -O         | readxml.c    |        |        |              |    |     |         |
   | cc | -c | -O         | init.c       |        |        |              |    |     |         |
   | cc | -c | -O         | util.c       |        |        |              |    |     |         |
   | cc | -c | -O         | bali_score.c |        |        |              |    |     |         |
   | cc | -o | bali_score | readxml.o    | init.o | util.o | bali_score.o | -O | -lm | -lexpat |

** Step 2: run tests

   #+BEGIN_SRC sh :session onesh
     cd ~/data/bb3_release
     cd .. 

     mkdir -p bb3_release_tmp_aln
     cd bb3_release_tmp_aln
     KALIGNOUTDIR=$PWD 
     echo $KALIGNOUTDIR

   #+END_SRC

   #+RESULTS:
   |                                                                             |
   | sh-4.4$ sh-4.4$ sh-4.4$ sh-4.4$ sh-4.4$ /home/user/data/bb3_release_tmp_aln |
   #+BEGIN_SRC sh :session onesh :results raw
     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); printf "kalign -alnp param_25.txt %s -o %s/%s_%skalign25.msf\n", $1,outdir,a[n-2],a[n-1] }' > run_kalign.sh


     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); printf "kalign -alnp param_50.txt  %s -o %s/%s_%skalign50.msf\n", $1,outdir,a[n-2],a[n-1] }' >> run_kalign.sh

     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); printf "kalign -alnp param_75.txt  %s -o %s/%s_%skalign75.msf\n", $1,outdir,a[n-2],a[n-1] }' >> run_kalign.sh

   #+END_SRC 

   #+BEGIN_SRC sh :session onesh :results raw 
     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); printf "kalign  %s -o %s/%s_%skalign.msf\n", $1,outdir,a[n-2],a[n-1] }' > run_kalign.sh

     find ~/data/bb3_release -name "*.tfa"  | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); printf "clustalo --dealign -i  %s --outfmt=msf -o %s/%s_%sclustalo.msf\n", $1,outdir,a[n-2],a[n-1] }' > run_clustalo.sh

      find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/);
     printf "kalign %s -set 0 -o %s/%s_%skalign_1.msf\n", $1,outdir,a[n-2],a[n-1] ;
     printf "kalign %s -set 1 -o %s/%s_%skalign_2.msf\n", $1,outdir,a[n-2],a[n-1] ;
     printf "kalign %s -set 2 -o %s/%s_%skalign_3.msf\n", $1,outdir,a[n-2],a[n-1] ;
     printf "kalign %s -set 3 -o %s/%s_%skalign_4.msf\n", $1,outdir,a[n-2],a[n-1] ;
     }' > run_kalign_cmsa.sh


find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/);
     printf "cmsa -a  %s/%s_%skalign_*.msf -out %s/%s_%skalign_cmsa.msf -f msf \n",outdir,a[n-2],a[n-1],outdir,a[n-2],a[n-1] ;
     }' > run_cmsa.sh

     chmod 755 run_kalign_cmsa.sh 


     chmod 755 run_kalign.sh 
     chmod 755 run_clustalo.sh

   #+END_SRC

   #+RESULTS:

   #+BEGIN_SRC sh :session onesh :results raw 

     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); ;printf "~/data/bb3_release/bali_score_src/bali_score %s %s/%s_%skalign.msf\n", $1,outdir,a[n-2],a[n-1] }' > alignment_scores.sh

     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); ;printf "~/data/bb3_release/bali_score_src/bali_score %s %s/%s_%skalign_1.msf\n", $1,outdir,a[n-2],a[n-1] }' > alignment_scores_set1.sh
     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); ;printf "~/data/bb3_release/bali_score_src/bali_score %s %s/%s_%skalign_2.msf\n", $1,outdir,a[n-2],a[n-1] }' > alignment_scores_set2.sh
     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); ;printf "~/data/bb3_release/bali_score_src/bali_score %s %s/%s_%skalign_3.msf\n", $1,outdir,a[n-2],a[n-1] }' > alignment_scores_set3.sh
     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); ;printf "~/data/bb3_release/bali_score_src/bali_score %s %s/%s_%skalign_4.msf\n", $1,outdir,a[n-2],a[n-1] }' > alignment_scores_set4.sh
     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); ;printf "~/data/bb3_release/bali_score_src/bali_score %s %s/%s_%skalign_5.msf\n", $1,outdir,a[n-2],a[n-1] }' > alignment_scores_set5.sh


     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); ;printf "~/data/bb3_release/bali_score_src/bali_score %s %s/%s_%skalign_cmsa.msf\n", $1,outdir,a[n-2],a[n-1] }' > alignment_scores_cmsa.sh

     find ~/data/bb3_release -name "*.xml" | awk -v outdir="$KALIGNOUTDIR" '{n=split ($1,a,/[\/,.]/); ;printf "~/data/bb3_release/bali_score_src/bali_score %s %s/%s_%sclustalo.msf\n", $1,outdir,a[n-2],a[n-1] }' >> alignment_scores.sh


     chmod 755 alignment_scores.sh
   #+END_SRC


   #+RESULTS:

   run the tests 

   #+BEGIN_SRC sh :session onesh
     parallel --jobs 5 < ./run_kalign.sh 
     parallel --jobs 5 < ./run_clustalo.sh 
     ./alignment_scores.sh | grep auto > scores2.csv

   #+END_SRC
   
** Step 3: plot scores 

   #+BEGIN_SRC R :session  one :results none :export none 

     library(tidyverse)
     library(ggplot2)
     library(stringi)
     library(cowplot)
     readBaliscores <-function(file,name){
       mat  <- read.table(file);
       colnames(mat) <- c("Type","Name","SP","TC")
       mat$Type <- name
       mat$Name <- sub(".*/" ,"", mat$Name)
       mat$Name <- sub("[A-Z,_]*[.]{1}[A-Z]*$" ,"", mat$Name,ignore.case = TRUE)
       mat <- as.tibble(mat)
       x = str_split(mat$Name, "_", n = Inf, simplify = TRUE)
       mat$Group <- x[,1] 
       return(mat)

     }


   #+END_SRC


   

   #+BEGIN_SRC R :session one :results output graphics :file BalibaseSP_scores.jpeg :exports both :width 160 :height 80

     mat <- readBaliscores("scores_kalign_old.csv","kalign old");
     mat <- rbind(mat,readBaliscores("scores_kalign_new.csv","kalign new"));
     mat <- rbind(mat,readBaliscores("scores_kalign_pbil2.csv","kalign pbil 2"));
     mat <- rbind(mat,readBaliscores("scores_kalign_16seed.csv","kalign 16 seed"));

     ##      mat <- rbind(mat,readBaliscores("scores_kalign_3.csv","kalign 3"));

     ## mata
     ## <- rbind(mat,readBaliscores("scores_kalign_bibpm.csv","bibpm"));
     ## mat 
     ## <- rbind(mat,readBaliscores("scores_kalign_bibpm_zero.csv","bibpm_zero"));


     p1 <- ggplot(mat, aes(Group, SP))
     p1 <- p1 + geom_boxplot(aes(colour = Type))

     means <- aggregate(SP ~  Type, mat, mean)
     means$SP <- round(means$SP,digits = 4)
     p2 <- ggplot(mat, aes(Type, SP))
     p2 <- p2 + geom_boxplot(aes(colour = Type))
     p2 <- p2 + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3,show.legend = FALSE) 
     p2 <- p2 + geom_text(data = means, aes(label = SP, y = SP + 0.08))

     p3 <- ggplot(mat, aes(Group, TC))
     p3 <- p3 + geom_boxplot(aes(colour = Type))

     means <- aggregate(TC ~  Type, mat, mean)
     means$TC <- round(means$TC,digits = 4)

     p4 <- ggplot(mat, aes(Type, TC))
     p4 <- p4 + geom_boxplot(aes(colour = Type))
     p4 <- p4 + geom_boxplot(aes(colour = Type))
     p4 <- p4 + stat_summary(fun.y=mean, colour="darkred", geom="point", shape=18, size=3,show.legend = FALSE) 
     p4 <- p4 + geom_text(data = means, aes(label = TC, y = TC + 0.08))



     p  = plot_grid(p1,p2,p3,p4, labels=c("SP", "TC"), ncol = 2, nrow= 2)




   #+END_SRC

   #+RESULTS:
   [[file:BalibaseSP_scores.jpeg]]



* Part 2: parameter optimisation


  Need a script to run kalign; balibase and return SP and TC scores.


  #+BEGIN_SRC bash -n :tangle run_kalign_bali_score.sh :shebang #!/usr/bin/env bash
    DIR=`pwd`
    INFILE=""
    ALNP=""
    NAME=""

    function usage()
    {
        printf "usage: $0 -i <test.fa> -a <alnpfile> -n <name>"
        exit 1;
    }


    while getopts i:a:n:  opt
    do
        case ${opt} in
            a) ALNP=${OPTARG};;
            i) INFILE=${OPTARG};;
            n) NAME=${OPTARG};;
            ,*) usage;;
        esac
    done

    if [ "${INFILE}" = "" ]; then usage; fi
    if [ "${ALNP}" = "" ]; then usage; fi
    if [ "${NAME}" = "" ]; then usage; fi

    #programs=(kalign bali_score)

    #printf "Running Sanity checks:\n";

    # for item in ${programs[*]}
    # do
    #     if which $item >/dev/null; then
    #         printf "%15s found.\n"  $item;
    #     else
    #         printf "\nERROR: %s not found!\n\n" $item;
    #         exit 1;
    #     fi
    # done
    tmpfile=$NAME 


    kalign -alnp $ALNP $INFILE -o $tmpfile > /dev/null 2>&1
    bali_score $INFILE  $tmpfile | grep auto 
    rm "$tmpfile"

  #+END_SRC

